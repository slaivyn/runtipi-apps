{
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json",
  "services": [
    {
      "name": "openproject-db",
      "image": "postgres:17",
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/postgres",
          "containerPath": "/var/lib/postgresql/data"
        }
      ],
      "environment": [
        {
          "key": "POSTGRES_PASSWORD",
          "value": "${OPENPROJECT_DB_PASSWORD}"
        },
        {
          "key": "POSTGRES_USER",
          "value": "postgres"
        },
        {
          "key": "POSTGRES_DB",
          "value": "openproject"
        }
      ],
      "healthCheck": {
        "test": "pg_isready -d openproject -U postgres",
        "interval": "30s",
        "timeout": "5s",
        "retries": 5,
        "startPeriod": "20s"
      }
    },
    {
      "name": "openproject-cache",
      "image": "memcached",
      "healthCheck": {
        "test": "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/11211'",
        "interval": "30s",
        "timeout": "5s",
        "retries": 5,
        "startPeriod": "20s"
      }
    },
    {
      "name": "openproject-web",
      "image": "openproject/openproject:16-slim",
      "isMain": true,
      "internalPort": 8080,
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/web",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        },
        "openproject-seeder": {
          "condition": "service_completed_successfully"
        }
      },
      "healthCheck": {
        "test": "curl -f http://localhost:8080/health_checks/default",
        "interval": "10s",
        "timeout": "3s",
        "retries": 3,
        "startPeriod": "30s"
      }
    },
    {
      "name": "openproject-worker",
      "image": "openproject/openproject:16-slim",
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/worker",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        },
        "openproject-seeder": {
          "condition": "service_completed_successfully"
        }
      }
    },
    {
      "name": "openproject-cron",
      "image": "openproject/openproject:16-slim",
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/cron",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        },
        "openproject-seeder": {
          "condition": "service_completed_successfully"
        }
      }
    },
    {
      "name": "openproject-seeder",
      "image": "openproject/openproject:16-slim",
      "restart": "on-failure",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        }
      },
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/seeder"
    }
  ]
}

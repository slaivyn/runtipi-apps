{
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json",
  "services": [
    {
      "name": "openproject-db",
      "image": "postgres:17",
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/postgres",
          "containerPath": "/var/lib/postgresql/data"
        }
      ],
      "environment": [
        {
          "key": "POSTGRES_PASSWORD",
          "value": "${OPENPROJECT_DB_PASSWORD}"
        },
        {
          "key": "POSTGRES_USER",
          "value": "postgres"
        },
        {
          "key": "POSTGRES_DB",
          "value": "openproject"
        }
      ],
      "healthCheck": {
        "test": "pg_isready -d openproject -U postgres",
        "interval": "30s",
        "timeout": "5s",
        "retries": 5,
        "startPeriod": "20s"
      }
    },
    {
      "name": "openproject-cache",
      "image": "memcached",
      "healthCheck": {
        "test": "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/11211'",
        "interval": "30s",
        "timeout": "5s",
        "retries": 5,
        "startPeriod": "20s"
      }
    },
    {
      "name": "openproject-web",
      "image": "openproject/openproject:17-slim",
      "isMain": true,
      "internalPort": 8080,
      "hostname": "${APP_DOMAIN}",
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_EMAIL__DELIVERY__METHOD",
          "value": "smtp"
        },
        {
          "key": "OPENPROJECT_SMTP__ADDRESS",
          "value": "${OPENPROJECT_SMTP_ADDRESS}"
        },
        {
          "key": "OPENPROJECT_SMTP__PORT",
          "value": "${OPENPROJECT_SMTP_PORT}"
        },
        {
          "key": "OPENPROJECT_SMTP__USER__NAME",
          "value": "${OPENPROJECT_SMTP_USERNAME}"
        },
        {
          "key": "OPENPROJECT_SMTP__PASSWORD",
          "value": "${OPENPROJECT_SMTP_PASSWORD}"
        },
        {
          "key": "OPENPROJECT_SMTP__ENABLE__STARTTLS__AUTO",
          "value": "${OPENPROJECT_SMTP_ENABLE_STARTTLS_AUTO}"
        },
        {
          "key": "OPENPROJECT_SMTP__SSL",
          "value": "${OPENPROJECT_SMTP_SSL}"
        },
        {
          "key": "OPENPROJECT_SMTP__AUTHENTICATION",
          "value": "${OPENPROJECT_SMTP_AUTHENTICATION}"
        },
        {
          "key": "OPENPROJECT_SMTP__DOMAIN",
          "value": "${OPENPROJECT_SMTP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_SMTP__OPENSSL__VERIFY__MODE",
          "value": "${OPENPROJECT_SMTP_OPENSSL_VERIFY_MODE}"
        },
        {
          "key": "OPENPROJECT_MAIL__FROM",
          "value": "${OPENPROJECT_MAIL_FROM}"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__URL",
          "value": "wss://${APP_DOMAIN}/hocuspocus"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__SECRET",
          "value": "${OPENPROJECT_HOCUSPOCUS_SECRET}"
        },
        {
          "key": "SECRET_KEY_BASE",
          "value": "${OPENPROJECT_SECRET_KEY_BASE}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/web",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        },
        "openproject-seeder": {
          "condition": "service_started"
        }
      },
      "healthCheck": {
        "test": "curl -f http://localhost:8080/health_checks/default",
        "interval": "10s",
        "timeout": "3s",
        "retries": 3,
        "startPeriod": "30s"
      }
    },
    {
      "name": "openproject-worker",
      "image": "openproject/openproject:17-slim",
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_EMAIL__DELIVERY__METHOD",
          "value": "smtp"
        },
        {
          "key": "OPENPROJECT_SMTP__ADDRESS",
          "value": "${OPENPROJECT_SMTP_ADDRESS}"
        },
        {
          "key": "OPENPROJECT_SMTP__PORT",
          "value": "${OPENPROJECT_SMTP_PORT}"
        },
        {
          "key": "OPENPROJECT_SMTP__USER__NAME",
          "value": "${OPENPROJECT_SMTP_USERNAME}"
        },
        {
          "key": "OPENPROJECT_SMTP__PASSWORD",
          "value": "${OPENPROJECT_SMTP_PASSWORD}"
        },
        {
          "key": "OPENPROJECT_SMTP__ENABLE__STARTTLS__AUTO",
          "value": "${OPENPROJECT_SMTP_ENABLE_STARTTLS_AUTO}"
        },
        {
          "key": "OPENPROJECT_SMTP__SSL",
          "value": "${OPENPROJECT_SMTP_SSL}"
        },
        {
          "key": "OPENPROJECT_SMTP__AUTHENTICATION",
          "value": "${OPENPROJECT_SMTP_AUTHENTICATION}"
        },
        {
          "key": "OPENPROJECT_SMTP__DOMAIN",
          "value": "${OPENPROJECT_SMTP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_SMTP__OPENSSL__VERIFY__MODE",
          "value": "${OPENPROJECT_SMTP_OPENSSL_VERIFY_MODE}"
        },
        {
          "key": "OPENPROJECT_MAIL__FROM",
          "value": "${OPENPROJECT_MAIL_FROM}"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__URL",
          "value": "wss://${APP_DOMAIN}/hocuspocus"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__SECRET",
          "value": "${OPENPROJECT_HOCUSPOCUS_SECRET}"
        },
        {
          "key": "SECRET_KEY_BASE",
          "value": "${OPENPROJECT_SECRET_KEY_BASE}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/worker",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        },
        "openproject-seeder": {
          "condition": "service_started"
        }
      }
    },
    {
      "name": "openproject-cron",
      "image": "openproject/openproject:17-slim",
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_EMAIL__DELIVERY__METHOD",
          "value": "smtp"
        },
        {
          "key": "OPENPROJECT_SMTP__ADDRESS",
          "value": "${OPENPROJECT_SMTP_ADDRESS}"
        },
        {
          "key": "OPENPROJECT_SMTP__PORT",
          "value": "${OPENPROJECT_SMTP_PORT}"
        },
        {
          "key": "OPENPROJECT_SMTP__USER__NAME",
          "value": "${OPENPROJECT_SMTP_USERNAME}"
        },
        {
          "key": "OPENPROJECT_SMTP__PASSWORD",
          "value": "${OPENPROJECT_SMTP_PASSWORD}"
        },
        {
          "key": "OPENPROJECT_SMTP__ENABLE__STARTTLS__AUTO",
          "value": "${OPENPROJECT_SMTP_ENABLE_STARTTLS_AUTO}"
        },
        {
          "key": "OPENPROJECT_SMTP__SSL",
          "value": "${OPENPROJECT_SMTP_SSL}"
        },
        {
          "key": "OPENPROJECT_SMTP__AUTHENTICATION",
          "value": "${OPENPROJECT_SMTP_AUTHENTICATION}"
        },
        {
          "key": "OPENPROJECT_SMTP__DOMAIN",
          "value": "${OPENPROJECT_SMTP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_SMTP__OPENSSL__VERIFY__MODE",
          "value": "${OPENPROJECT_SMTP_OPENSSL_VERIFY_MODE}"
        },
        {
          "key": "OPENPROJECT_MAIL__FROM",
          "value": "${OPENPROJECT_MAIL_FROM}"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__URL",
          "value": "wss://${APP_DOMAIN}/hocuspocus"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__SECRET",
          "value": "${OPENPROJECT_HOCUSPOCUS_SECRET}"
        },
        {
          "key": "SECRET_KEY_BASE",
          "value": "${OPENPROJECT_SECRET_KEY_BASE}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "./docker/prod/cron",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        },
        "openproject-seeder": {
          "condition": "service_started"
        }
      }
    },
    {
      "name": "openproject-seeder",
      "image": "openproject/openproject:17-slim",
      "restart": "on-failure",
      "dependsOn": {
        "openproject-db": {
          "condition": "service_healthy"
        },
        "openproject-cache": {
          "condition": "service_healthy"
        }
      },
      "environment": [
        {
          "key": "OPENPROJECT_HTTPS",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_HOST__NAME",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_HSTS",
          "value": "false"
        },
        {
          "key": "RAILS_CACHE_STORE",
          "value": "memcache"
        },
        {
          "key": "OPENPROJECT_CACHE__MEMCACHE__SERVER",
          "value": "openproject-cache:11211"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://postgres:${OPENPROJECT_DB_PASSWORD}@openproject-db/openproject?pool=20&encoding=unicode&reconnect=true"
        },
        {
          "key": "RAILS_MIN_THREADS",
          "value": "4"
        },
        {
          "key": "RAILS_MAX_THREADS",
          "value": "16"
        },
        {
          "key": "IMAP_ENABLED",
          "value": "false"
        },
        {
          "key": "OPENPROJECT_EMAIL__DELIVERY__METHOD",
          "value": "smtp"
        },
        {
          "key": "OPENPROJECT_SMTP__ADDRESS",
          "value": "${OPENPROJECT_SMTP_ADDRESS}"
        },
        {
          "key": "OPENPROJECT_SMTP__PORT",
          "value": "${OPENPROJECT_SMTP_PORT}"
        },
        {
          "key": "OPENPROJECT_SMTP__USER__NAME",
          "value": "${OPENPROJECT_SMTP_USERNAME}"
        },
        {
          "key": "OPENPROJECT_SMTP__PASSWORD",
          "value": "${OPENPROJECT_SMTP_PASSWORD}"
        },
        {
          "key": "OPENPROJECT_SMTP__ENABLE__STARTTLS__AUTO",
          "value": "${OPENPROJECT_SMTP_ENABLE_STARTTLS_AUTO}"
        },
        {
          "key": "OPENPROJECT_SMTP__SSL",
          "value": "${OPENPROJECT_SMTP_SSL}"
        },
        {
          "key": "OPENPROJECT_SMTP__AUTHENTICATION",
          "value": "${OPENPROJECT_SMTP_AUTHENTICATION}"
        },
        {
          "key": "OPENPROJECT_SMTP__DOMAIN",
          "value": "${OPENPROJECT_SMTP_DOMAIN}"
        },
        {
          "key": "OPENPROJECT_SMTP__OPENSSL__VERIFY__MODE",
          "value": "${OPENPROJECT_SMTP_OPENSSL_VERIFY_MODE}"
        },
        {
          "key": "OPENPROJECT_MAIL__FROM",
          "value": "${OPENPROJECT_MAIL_FROM}"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__URL",
          "value": "wss://${APP_DOMAIN}/hocuspocus"
        },
        {
          "key": "OPENPROJECT_COLLABORATIVE__EDITING__HOCUSPOCUS__SECRET",
          "value": "${OPENPROJECT_HOCUSPOCUS_SECRET}"
        },
        {
          "key": "SECRET_KEY_BASE",
          "value": "${OPENPROJECT_SECRET_KEY_BASE}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/assets",
          "containerPath": "/var/openproject/assets"
        }
      ],
      "command": "sh -c './docker/prod/seeder && exec tail -f /dev/null'"
    },
    {
      "name": "openproject-hocuspocus",
      "image": "openproject/hocuspocus:17.0.3",
      "environment": [
        {
          "key": "SECRET",
          "value": "${OPENPROJECT_HOCUSPOCUS_SECRET}"
        }
      ]
    }
  ]
}
